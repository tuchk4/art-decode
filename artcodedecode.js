!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).artcodedecode={},e.fs)}(this,function(e,t){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=r(t);function n(e,i,c,u){return new(c=c||Promise)(function(r,t){function n(e){try{a(u.next(e))}catch(e){t(e)}}function o(e){try{a(u.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(n,o)}a((u=u.apply(e,i||[])).next())})}function c(r,n){var o,a,i,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(i=2&t[0]?a.return:t[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,t[1])).done)return i;switch(a=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(i=0<(i=c.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){c.label=t[1];break}if(6===t[0]&&c.label<i[1]){c.label=i[1],i=t;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(t);break}i[2]&&c.ops.pop(),c.trys.pop();continue}t=n.call(r,c)}catch(e){t=[6,e],a=0}finally{o=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function k(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&n>=e.length?void 0:e)&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function u(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,a=r.call(e),i=[];try{for(;(void 0===t||0<t--)&&!(n=a.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return i}function l(e){return 1==(e=e.toString(16)).length?"0".concat(e):e}function o(o,e){var t,a=function(e){var t,r;void 0===e&&(e={});var n=new Set;try{for(var o=k(Object.keys(e)),a=o.next();!a.done;a=o.next()){var i=a.value,c=Array.isArray(e[i])?e[i]:Array(i.length).fill(d(e[i]));if(c.length!==i.length)throw new Error("colors length missmatch");c.reduce(function(e,t){t=e+t.toLowerCase();return n.add(t),t},"")}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n}(null!==(t=e.matches)&&void 0!==t?t:{}),i=function(e){var t,r;void 0===e&&(e={});var n=new Map;try{for(var o=k(Object.keys(e)),a=o.next();!a.done;a=o.next()){var i=a.value,c=Array.isArray(e[i])?e[i]:Array(i.length).fill(d(e[i]));if(c.length!==i.length)throw new Error("colors length missmatch");n.set(c.map(function(e){return e.toLowerCase()}).join(""),i)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n}(null!==(e=e.matches)&&void 0!==e?e:{});return{pool:function(){function r(){var e=i.get(n);e?t.push(e):t.push.apply(t,function(e,t,r){if(r||2===arguments.length)for(var n,o=0,a=t.length;o<a;o++)!n&&o in t||((n=n||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}([],u(n.split("#").map(function(e){return o("#".concat(e))}).join("")),!1))}var n="",t=[];return{add:function(e){var t=n+e;a.has(t)?n+=e:(r(),n=e)},getSymbols:function(){return n&&r(),t}}}}}var f=function(e,t){return Object.assign(document.createElement("canvas"),{width:e,height:t})},s=function(o,a){return new Promise(function(e,t){const r=Object.assign(document.createElement("img"),a);function n(){r.onload=null,r.onerror=null}r.onload=function(){n(),e(r)},r.onerror=function(){n(),t(new Error('Failed to load the image "'+o+'"'))},r.src=o})},d=function(e){return"".concat(e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,r,n){return"#".concat(t+t+r+r+n+n)}))},h=function(n,e){var o=n.getContext("2d");null!=e&&e(n),o.fillStyle="transparent",o.fillRect(0,0,n.width,n.height);var a=o.createImageData(1,1);return{getAt:function(e,t){var r=u(o.getImageData(e,t,1,1).data,3),e=r[0],t=r[1],r=r[2];return"#".concat(l((r={r:e,g:t,b:r}).r)).concat(l(r.g)).concat(l(r.b))},setAt:function(e,t,r){r=function(e){e=d(e),e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:0,g:0,b:0}}(r);return a.data[0]=r.r,a.data[1]=r.g,a.data[2]=r.b,a.data[3]=255,o.putImageData(a,e,t),Promise.resolve()},getSize:function(){return{width:n.width,height:n.height}},save:function(e){var t=i.default.createWriteStream(e),r=n.createPNGStream({});return new Promise(function(e){r.pipe(t),t.on("finish",function(){return e()})})}}};var a="#3399ff",v={create:function(e){var t,r=null!==(t=(e=void 0===e?{}:e).delta)&&void 0!==t?t:1220,n=null!==(t=e.emptyColor)&&void 0!==t?t:"#000";return{options:e,getMarker:function(){return a},decode:function(e){if(e===n)return"";e=parseInt(e.replace("#",""),16)-r;return 31<e||10==e||13==e?String.fromCharCode(e):""}}},marker:a},I=new Map;m="char-code",I.set(m,v);function p(e,t){A.set(e,t)}var y="#ffcc33",t={create:function(t,e){var d=null!==(n=(e=void 0===e?{}:e).padding)&&void 0!==n?n:0,r=w(t.options,e),n=null!==(n=e.step)&&void 0!==n?n:1,h=n<1?1:n;return{options:e,getMarker:function(){return y},iterateImage:function(i){var c=o(t.decode,{matches:t.options.matches}),e=i.getSize(),u=e.width,l=e.height,f=Math.floor(r/u),s=r-f*u;return new Promise(function(e){for(var t=c.pool(),r=d<f?f:d,n=r;n<l-d;n+=h)for(var o=n!==r||f<d?d:s;o<u-d;o+=h){var a=i.getAt(o,n);t.add(a)}e(t.getSymbols().join(""))})}}},marker:y},g="#cc0000",m={create:function(f,e){var s=null!==(r=(e=void 0===e?{}:e).padding)&&void 0!==r?r:0,t=w(f.options,e),r=null!==(r=e.step)&&void 0!==r?r:1,d=r<1?1:r;return{options:e,getMarker:function(){return g},iterateImage:function(a){var i=o(f.decode,{matches:f.options.matches}),e=a.getSize(),c=e.width,u=e.height,l=Math.floor(t/c);return new Promise(function(e){for(var t=i.pool(),r=s<=l?l+1:s;r<u-s;r+=d)for(var n=s;n<c-s;n+=d){var o=a.getAt(n,r);if(t.add(o),"\n"===f.decode(o))break}e(t.getSymbols().join(""))})}}},marker:g},A=new Map;p("linear",t),p("lines",m);var j="#cc0000",C=v.create({});function w(e,t){return 2+JSON.stringify(e).length+1+JSON.stringify(t).length+1}function b(t){var r,e,n,o,a=(v=t.getSize()).width,i=v.height,c=0,u=0;function l(){var e=t.getAt(u,c).toLowerCase();return function(){if(a-1<++u&&(u=0,c++),a-1<u||i-1<c)throw new Error(":(")}(),e}function f(){var e="",t=l();return t!==j&&(e+=C.decode(t),e+=f()),e}var s=l(),d=l(),h=f(),v=f(),p=null,y=null;try{for(var g=k(I.entries()),m=g.next();!m.done;m=g.next()){var w=m.value;if(w[1].marker===s){p=w[1];break}}}catch(e){r={error:e}}finally{try{m&&!m.done&&(e=g.return)&&e.call(g)}finally{if(r)throw r.error}}try{for(var b=k(A.entries()),S=b.next();!S.done;S=b.next()){var x=S.value;if(x[1].marker===d){y=x[1];break}}}catch(e){n={error:e}}finally{try{S&&!S.done&&(o=b.return)&&o.call(b)}finally{if(n)throw n.error}}if(!p)throw new Error("Can not find theme");if(!y)throw new Error("Can not find iterator");return{theme:{factory:p,options:JSON.parse(null!=h?h:{})},iterator:{factory:y,options:JSON.parse(null!=v?v:{})}}}e.decode=function(a){return n(void 0,void 0,void 0,function(){var r,n,o;return c(this,function(e){switch(e.label){case 0:return[4,(t=a,new Promise(function(r,e){s(t).then(function(e){var t=f(e.width,e.height);t.getContext("2d").drawImage(e,0,0),r(h(t))})}))];case 1:return r=e.sent(),n=b(r),o=n.theme.factory.create(n.theme.options),[4,n.iterator.factory.create(o,n.iterator.options).iterateImage(r)];case 2:return[2,e.sent()]}var t})})},e.decodeFromBase64=function(a){return n(void 0,void 0,void 0,function(){var t,r,o;return c(this,function(e){switch(e.label){case 0:return[4,(n=a,new Promise(function(t,e){var r=new Image;r.onerror=function(){e(new Error("broken file"))},r.onload=function(){var e=f(r.width,r.height);e.getContext("2d").drawImage(r,0,0),t(h(e))},r.src=n}))];case 1:return t=e.sent(),r=b(t),o=r.theme.factory.create(r.theme.options),[4,r.iterator.factory.create(o,r.iterator.options).iterateImage(t)];case 2:return[2,e.sent()]}var n})})},Object.defineProperty(e,"__esModule",{value:!0})});
